<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Audio DJ Controller</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #0a0a0a;
      color: #eee;
      font-family: 'Inter', sans-serif;
      user-select: none;
    }
    .deck {
      background: #1a1a1a;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      padding: 1rem;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      font-size: 0.8rem;
      min-width: 90px;
      flex-grow: 1;
    }
    input[type=range] {
      width: 100%;
      background: #333;
      height: 12px; /* Increased height for better touch target */
      border-radius: 6px;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      margin-top: 8px;
      touch-action: pan-x;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px; height: 24px; /* Larger thumb for touch */
      background: #0af;
      cursor: pointer; border-radius: 50%; border: none;
      box-shadow: 0 0 4px rgba(0, 170, 255, 0.7);
    }
    input[type=range]::-moz-range-thumb {
      width: 24px; height: 24px; /* Larger thumb for touch */
      background: #0af;
      cursor: pointer; border-radius: 50%; border: none;
      box-shadow: 0 0 4px rgba(0, 170, 255, 0.7);
    }
    .step, .melstep {
      width: 100%; height: 28px;
      background: #333;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
      box-shadow: inset 0 0 6px #000;
      border: none;
      margin: 0; padding: 0;
      font-size: .93em;
      color: #eee;
      outline: none;
      display: flex; align-items: center; justify-content: center;
    }
    .step.active { background: #1fd6f7; box-shadow: 0 0 8px #1fd6f7; }
    .melstep.active { background: #1fd6f7; color: #121212; box-shadow: 0 0 8px #1fd6f7; }
    .step.playing, .melstep.playing { background: #ffc200; color: #212; }
    button {
      background: #0af;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s, transform 0.1s;
      box-shadow: 0 4px 6px rgba(0, 170, 255, 0.3);
    }
    button:hover { background: #08a; }
    button.recording {
        background: #f44336; /* Red for recording */
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
        100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }
    #messageBox {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #333; color: #eee; padding: 20px; border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); z-index: 1000;
      display: none; text-align: center; min-width: 250px; max-width: 80%;
    }
    #messageBox button { margin-top: 15px; }
    .sequencer-grid {
        display: grid;
        grid-template-columns: repeat(16, minmax(0, 1fr));
        gap: 4px;
    }
    .drum-label-container {
        grid-column: span 16;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #0af;
    }
  </style>
</head>
<body class="p-4">
  <h1 class="text-3xl font-bold text-center mb-4 text-cyan-400">Web Audio DJ Controller</h1>
  
  <div class="grid grid-cols-1 lg:grid-cols-11 gap-4">
    <!-- Deck A -->
    <div class="lg:col-span-5 deck" id="deck-A">
      <h2 class="text-2xl font-bold text-center mb-4 text-cyan-400">Deck A</h2>
      <!-- All controls will be dynamically inserted here -->
    </div>

    <!-- Mixer -->
    <div class="lg:col-span-1 deck flex flex-col items-center justify-center bg-black/50 space-y-4" id="mixer">
       <h2 class="text-2xl font-bold text-center mb-4 text-white">MIXER</h2>
       <button id="deck-toggle" class="lg:hidden w-full py-2 px-4 bg-purple-600 hover:bg-purple-500 rounded-lg">Show Deck B</button>
       <div class="control-group w-full">
         <label for="crossfader" class="text-center">Crossfader</label>
         <input type="range" min="-1" max="1" value="0" step="0.01" id="crossfader" class="w-full" />
         <div class="flex justify-between text-xs mt-1 px-1">
           <span>A</span>
           <span>B</span>
         </div>
       </div>
       <div id="master-effects" class="w-full space-y-4 pt-4 border-t border-gray-700">
            <h3 class="text-lg font-bold text-center text-white">Master FX</h3>
            <div class="control-group w-full"><label>LPF</label><input type="range" min="100" max="20000" value="20000" id="master-lpf" /><span id="master-lpf-val">20k</span></div>
            <div class="control-group w-full"><label>HPF</label><input type="range" min="20" max="10000" value="20" id="master-hpf" /><span id="master-hpf-val">20</span></div>
            <div class="control-group w-full"><label>Reverb</label><input type="range" min="0" max="1" step="0.01" value="0" id="master-reverb" /><span id="master-reverb-val">0</span></div>
            <div class="control-group w-full"><label>EQ Gain</label><input type="range" min="-12" max="12" value="0" id="master-eqgain" /><span id="master-eqgain-val">0</span></div>
       </div>
       <div class="w-full pt-4 border-t border-gray-700">
            <button id="master-record" class="w-full">Record Mix</button>
       </div>
    </div>

    <!-- Deck B -->
    <div class="lg:col-span-5 deck hidden lg:block" id="deck-B">
      <h2 class="text-2xl font-bold text-center mb-4 text-cyan-400">Deck B</h2>
       <!-- All controls will be dynamically inserted here -->
    </div>
  </div>

  <div id="messageBox">
    <p id="messageBoxText"></p>
    <button id="messageBoxCloseBtn">OK</button>
  </div>

<script>
const drumNames = ["Kick", "Snare", "HiHat", "Clap", "Tom", "Rimshot"];
const stepsCount = 16;
const scale = [60, 62, 64, 65, 67, 69, 71, 72];
const noteNames = ['C','D','E','F','G','A','B','C'];

class Deck {
    constructor(id, audioContext, masterGain) {
        this.id = id;
        this.ctx = audioContext;
        this.container = document.getElementById(`deck-${id}`);
        this.masterGain = masterGain;

        this.pattern = drumNames.map(() => ({ steps: new Array(stepsCount).fill(false), chorusEnabled: false }));
        this.synthSeqPattern = Array(stepsCount).fill(null);
        this.synthChorusEnabled = false;
        this.isPlaying = false;
        this.currentStep = 0;
        this.timerId = null;
        this.tempo = 125;
        
        this.allSliders = [
            'lpfCutoff', 'hpfCutoff', 'lowGain', 'midGain', 'highGain', 
            'distortionAmount', 'delayTime', 'delayFeedback', 'delayMix', 
            'flangerSpeed', 'tremoloFreq', 'tremoloDepth', 'reverbMix'
        ];

        this.initUI();
        this.initAudio();
        this.setupEventListeners();
        this.updateCategoryList();
    }

    initUI() {
        this.container.innerHTML += `
            <div class="main-controls">
                <div class="control-group"><label>LPF Cutoff</label><input type="range" min="100" max="8000" value="8000" id="lpfCutoff-${this.id}" /><span id="lpfCutoffVal-${this.id}">8000</span></div>
                <div class="control-group"><label>HPF Cutoff</label><input type="range" min="20" max="4000" value="20" id="hpfCutoff-${this.id}" /><span id="hpfCutoffVal-${this.id}">20</span></div>
                <div class="control-group"><label>High Gain</label><input type="range" min="-24" max="12" value="0" id="highGain-${this.id}" /><span id="highGainVal-${this.id}">0</span></div>
                <div class="control-group"><label>Mid Gain</label><input type="range" min="-24" max="12" value="0" id="midGain-${this.id}" /><span id="midGainVal-${this.id}">0</span></div>
                <div class="control-group"><label>Low Gain</label><input type="range" min="-24" max="12" value="0" id="lowGain-${this.id}" /><span id="lowGainVal-${this.id}">0</span></div>
            </div>
            <div class="effect-controls flex flex-wrap gap-4">
                <div class="control-group"><label>Distortion</label><input type="range" min="0" max="100" value="0" id="distortionAmount-${this.id}" /><span id="distortionAmountVal-${this.id}">0</span></div>
                <div class="control-group"><label>Reverb Mix</label><input type="range" min="0" max="1" step="0.01" value="0" id="reverbMix-${this.id}" /><span id="reverbMixVal-${this.id}">0</span></div>
                <div class="control-group"><label>Echo Time</label><input type="range" min="0" max="1" step="0.01" value="0.3" id="delayTime-${this.id}" /><span id="delayTimeVal-${this.id}">0.3</span></div>
                <div class="control-group"><label>Echo Fdbk</label><input type="range" min="0" max="0.95" step="0.01" value="0.4" id="delayFeedback-${this.id}" /><span id="delayFeedbackVal-${this.id}">0.4</span></div>
                <div class="control-group"><label>Echo Mix</label><input type="range" min="0" max="1" step="0.01" value="0" id="delayMix-${this.id}" /><span id="delayMixVal-${this.id}">0</span></div>
                <div class="control-group"><label>Flanger Spd</label><input type="range" min="0.1" max="10" step="0.1" value="1" id="flangerSpeed-${this.id}" /><span id="flangerSpeedVal-${this.id}">1</span></div>
                <div class="control-group"><label>Tremolo Freq</label><input type="range" min="0.1" max="20" step="0.1" value="5" id="tremoloFreq-${this.id}" /><span id="tremoloFreqVal-${this.id}">5</span></div>
                <div class="control-group"><label>Tremolo Depth</label><input type="range" min="0" max="1" step="0.01" value="0" id="tremoloDepth-${this.id}" /><span id="tremoloDepthVal-${this.id}">0</span></div>
            </div>
            <div class="my-4 flex gap-2"><button id="playBtn-${this.id}">▶ Play</button><button id="stopBtn-${this.id}" disabled>■ Stop</button><button id="cueBtn-${this.id}">CUE</button></div>
            <div id="sequencer-${this.id}" class="sequencer-grid"></div>
            <div class="drum-label-container mt-4" style="color:#96f;"><span id="melody-label-${this.id}">Synth Melody</span><input type="checkbox" id="synthChorusToggle-${this.id}" /><label for="synthChorusToggle-${this.id}">Chorus</label></div>
            <div id="synthseq-${this.id}" class="sequencer-grid"></div>
            <div id="pattern-manager-${this.id}" class="mt-4 flex flex-wrap gap-2 items-center">
                <input type="text" id="snippetName-${this.id}" placeholder="Pattern Name" class="flex-grow" /><input type="text" id="snippetCat-${this.id}" placeholder="Category" class="flex-grow" /><button id="saveBtn-${this.id}">Save</button>
                <select id="catFilter-${this.id}"></select><select id="savedSnippets-${this.id}"></select><button id="loadBtn-${this.id}">Load</button>
            </div>
        `;
        this.buildSequencerGrid();
        this.buildSynthGrid();
    }

    initAudio() {
        this.mainInputNode = this.ctx.createGain();
        this.distortionNode = this.ctx.createWaveShaper();
        this.reverbNode = this.ctx.createConvolver();
        this.reverbWetGain = this.ctx.createGain();
        this.reverbDryGain = this.ctx.createGain();
        this.lpfNode = this.ctx.createBiquadFilter();
        this.lpfNode.type = 'lowpass';
        this.hpfNode = this.ctx.createBiquadFilter();
        this.hpfNode.type = 'highpass';
        this.lowEQ = this.ctx.createBiquadFilter();
        this.lowEQ.type = 'lowshelf';
        this.lowEQ.frequency.value = 250;
        this.midEQ = this.ctx.createBiquadFilter();
        this.midEQ.type = 'peaking';
        this.midEQ.frequency.value = 1000;
        this.highEQ = this.ctx.createBiquadFilter();
        this.highEQ.type = 'highshelf';
        this.highEQ.frequency.value = 4000;
        
        this.reverbNode.buffer = this.createReverbImpulseResponse();
        
        this.mainInputNode.connect(this.distortionNode);
        this.distortionNode.connect(this.lowEQ);
        this.lowEQ.connect(this.midEQ);
        this.midEQ.connect(this.highEQ);
        this.highEQ.connect(this.hpfNode);
        this.hpfNode.connect(this.lpfNode);
        this.lpfNode.connect(this.reverbDryGain);
        this.lpfNode.connect(this.reverbNode);
        this.reverbNode.connect(this.reverbWetGain);
        this.reverbDryGain.connect(this.masterGain);
        this.reverbWetGain.connect(this.masterGain);
        
        this.setFiltersFromUI();
    }

    buildSequencerGrid() {
        const seqDiv = this.container.querySelector(`#sequencer-${this.id}`);
        seqDiv.innerHTML = '';
        drumNames.forEach((name, dIdx) => {
            const labelContainer = document.createElement('div');
            labelContainer.className = "drum-label-container";
            labelContainer.innerHTML = `<span>${name}</span><input type="checkbox" id="drumChorus_${dIdx}-${this.id}" title="Enable chorus for ${name}" /><label for="drumChorus_${dIdx}-${this.id}">Chorus</label>`;
            seqDiv.appendChild(labelContainer);
            for (let s = 0; s < stepsCount; s++) {
                const stepEl = document.createElement('button');
                stepEl.className = 'step';
                stepEl.dataset.drum = dIdx;
                stepEl.dataset.step = s;
                if (this.pattern[dIdx].steps[s]) stepEl.classList.add('active');
                stepEl.onclick = () => {
                    this.pattern[dIdx].steps[s] = !this.pattern[dIdx].steps[s];
                    stepEl.classList.toggle('active');
                };
                seqDiv.appendChild(stepEl);
            }
        });
    }

    buildSynthGrid() {
        const synthSeqDiv = this.container.querySelector(`#synthseq-${this.id}`);
        synthSeqDiv.innerHTML = '';
        for (let s = 0; s < stepsCount; s++) {
            const cell = document.createElement('button');
            cell.className = 'melstep';
            if (this.synthSeqPattern[s] !== null) cell.classList.add('active');
            cell.innerHTML = this.synthSeqPattern[s] === null ? '' : noteNames[this.synthSeqPattern[s]];
            cell.onclick = () => {
                if (this.synthSeqPattern[s] === null) this.synthSeqPattern[s] = 0;
                else if (this.synthSeqPattern[s] < scale.length - 1) this.synthSeqPattern[s]++;
                else this.synthSeqPattern[s] = null;
                cell.innerHTML = this.synthSeqPattern[s] === null ? '' : noteNames[this.synthSeqPattern[s]];
                cell.classList.toggle('active', this.synthSeqPattern[s] !== null);
            };
            synthSeqDiv.appendChild(cell);
        }
    }

    setFiltersFromUI() {
        this.lpfNode.frequency.value = +this.container.querySelector(`#lpfCutoff-${this.id}`).value;
        this.hpfNode.frequency.value = +this.container.querySelector(`#hpfCutoff-${this.id}`).value;
        this.lowEQ.gain.value = +this.container.querySelector(`#lowGain-${this.id}`).value;
        this.midEQ.gain.value = +this.container.querySelector(`#midGain-${this.id}`).value;
        this.highEQ.gain.value = +this.container.querySelector(`#highGain-${this.id}`).value;
        this.distortionNode.curve = this.makeDistortionCurve(+this.container.querySelector(`#distortionAmount-${this.id}`).value);
        const reverbMix = +this.container.querySelector(`#reverbMix-${this.id}`).value;
        this.reverbDryGain.gain.value = 1 - reverbMix;
        this.reverbWetGain.gain.value = reverbMix;
    }
    
    makeDistortionCurve(amount) {
        const k = typeof amount === 'number' ? amount : 50, n_samples = 44100, curve = new Float32Array(n_samples), deg = Math.PI / 180;
        for (let i = 0; i < n_samples; ++i) {
            const x = i * 2 / n_samples - 1;
            curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
        }
        return curve;
    }

    createReverbImpulseResponse(duration = 2, decay = 2) {
        const sampleRate = this.ctx.sampleRate;
        const length = sampleRate * duration;
        const impulse = this.ctx.createBuffer(2, length, sampleRate);
        const impulseL = impulse.getChannelData(0);
        const impulseR = impulse.getChannelData(1);
        for (let i = 0; i < length; i++) {
            impulseL[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
            impulseR[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
        }
        return impulse;
    }
    
    playStep(step) {
        drumNames.forEach((name, dIdx) => {
            if (this.pattern[dIdx].steps[step]) {
                let sourceNode;
                if (dIdx === 0) { // Kick
                    const osc = this.ctx.createOscillator();
                    osc.frequency.setValueAtTime(120, this.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(42, this.ctx.currentTime + 0.1);
                    const gain = this.ctx.createGain();
                    gain.gain.setValueAtTime(1, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.12);
                    osc.connect(gain);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 0.15);
                    sourceNode = gain;
                }
                // Add other drum sounds here...
                if(sourceNode) sourceNode.connect(this.mainInputNode);
            }
        });
         if (this.synthSeqPattern[step] !== null) {
            const freq = 440 * Math.pow(2, (scale[this.synthSeqPattern[step]] - 69) / 12);
            const osc = this.ctx.createOscillator();
            osc.frequency.value = freq;
            const gain = this.ctx.createGain();
            gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
            osc.connect(gain);
            gain.connect(this.mainInputNode);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.2);
        }
    }

    sequencerLoop() {
        if (!this.isPlaying) return;
        this.playStep(this.currentStep);
        this.currentStep = (this.currentStep + 1) % stepsCount;
        this.timerId = setTimeout(() => this.sequencerLoop(), (60 / this.tempo) / 4 * 1000);
    }
    
    setupEventListeners() {
        this.container.querySelector(`#playBtn-${this.id}`).onclick = () => {
            if (this.ctx.state === 'suspended') this.ctx.resume();
            this.isPlaying = true;
            this.container.querySelector(`#playBtn-${this.id}`).disabled = true;
            this.container.querySelector(`#stopBtn-${this.id}`).disabled = false;
            this.sequencerLoop();
        };
        this.container.querySelector(`#stopBtn-${this.id}`).onclick = () => {
            this.isPlaying = false;
            this.container.querySelector(`#playBtn-${this.id}`).disabled = false;
            this.container.querySelector(`#stopBtn-${this.id}`).disabled = true;
            clearTimeout(this.timerId);
        };
        this.container.querySelector(`#cueBtn-${this.id}`).onclick = () => {
            this.currentStep = 0;
            // Add visual feedback if desired
        };
        this.container.querySelectorAll('input[type=range]').forEach(slider => {
            slider.oninput = (e) => {
                const span = this.container.querySelector(`#${e.target.id.replace('-'+this.id, '')}Val-${this.id}`);
                if(span) span.textContent = e.target.value;
                this.setFiltersFromUI();
            };
        });
        this.container.querySelector(`#saveBtn-${this.id}`).onclick = () => this.saveCurrentPattern();
        this.container.querySelector(`#loadBtn-${this.id}`).onclick = () => this.loadSelectedPattern();
        this.container.querySelector(`#catFilter-${this.id}`).onchange = () => this.updatePatternList();
    }
    
    loadSnippetsFromLS() { return JSON.parse(localStorage.getItem(`djControllerPatterns-${this.id}`) || '{}'); }
    saveSnippetsToLS(obj) { localStorage.setItem(`djControllerPatterns-${this.id}`, JSON.stringify(obj)); }
    updateCategoryList() {
        const data = this.loadSnippetsFromLS();
        const catFilter = this.container.querySelector(`#catFilter-${this.id}`);
        const categories = Object.keys(data).sort();
        catFilter.innerHTML = '';
        categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            catFilter.appendChild(opt);
        });
        if (categories.length) {
            catFilter.value = categories[0];
            this.updatePatternList();
        }
    }
    updatePatternList() {
        const data = this.loadSnippetsFromLS();
        const catFilter = this.container.querySelector(`#catFilter-${this.id}`);
        const savedSnippets = this.container.querySelector(`#savedSnippets-${this.id}`);
        const cat = catFilter.value;
        savedSnippets.innerHTML = '';
        if (data[cat]) {
            data[cat].forEach((patternObj, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = patternObj.name || `Pattern ${idx + 1}`;
                savedSnippets.appendChild(opt);
            });
        }
    }
    saveCurrentPattern() {
        const name = this.container.querySelector(`#snippetName-${this.id}`).value.trim() || `Pattern ${Date.now()}`;
        const cat = this.container.querySelector(`#snippetCat-${this.id}`).value.trim() || 'Default';
        let data = this.loadSnippetsFromLS();
        if (!data[cat]) data[cat] = [];
        const settings = {};
        this.allSliders.forEach(sliderId => {
            const slider = this.container.querySelector(`#${sliderId}-${this.id}`);
            if(slider) settings[sliderId] = slider.value;
        });
        const patternData = { name, pattern: this.pattern, melody: this.synthSeqPattern, settings };
        data[cat].push(patternData);
        this.saveSnippetsToLS(data);
        this.updateCategoryList();
        showMessageBox(`Pattern "${name}" saved to Deck ${this.id}.`);
    }
    loadSelectedPattern() {
        const cat = this.container.querySelector(`#catFilter-${this.id}`).value;
        const idx = this.container.querySelector(`#savedSnippets-${this.id}`).value;
        const data = this.loadSnippetsFromLS();
        if (!data[cat] || !data[cat][idx]) return;
        const loaded = data[cat][idx];
        this.pattern = loaded.pattern;
        this.synthSeqPattern = loaded.melody;
        this.buildSequencerGrid();
        this.buildSynthGrid();
        if (loaded.settings) {
            this.allSliders.forEach(sliderId => {
                const slider = this.container.querySelector(`#${sliderId}-${this.id}`);
                if (slider && loaded.settings[sliderId] !== undefined) {
                    slider.value = loaded.settings[sliderId];
                    slider.dispatchEvent(new Event('input'));
                }
            });
        }
        showMessageBox(`Pattern "${loaded.name}" loaded on Deck ${this.id}.`);
    }
}

// --- Main Application Setup ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// Deck Outputs
const gainA = audioCtx.createGain();
const gainB = audioCtx.createGain();

// Master Bus
const masterBus = audioCtx.createGain();
gainA.connect(masterBus);
gainB.connect(masterBus);

// Master Effects
const masterLpf = audioCtx.createBiquadFilter();
masterLpf.type = 'lowpass';
masterLpf.frequency.value = 20000;
const masterHpf = audioCtx.createBiquadFilter();
masterHpf.type = 'highpass';
masterHpf.frequency.value = 20;
const masterEq = audioCtx.createBiquadFilter();
masterEq.type = 'peaking';
masterEq.gain.value = 0;
const masterReverb = audioCtx.createConvolver();
const masterReverbWet = audioCtx.createGain();
masterReverbWet.gain.value = 0;
const masterReverbDry = audioCtx.createGain();
masterReverbDry.gain.value = 1;

// Master Chain
masterBus.connect(masterHpf);
masterHpf.connect(masterEq);
masterEq.connect(masterLpf);
masterLpf.connect(masterReverbDry);
masterLpf.connect(masterReverb);
masterReverb.connect(masterReverbWet);

// Master Recorder Setup
const masterRecorderDestination = audioCtx.createMediaStreamDestination();
masterReverbDry.connect(masterRecorderDestination);
masterReverbWet.connect(masterRecorderDestination);
masterReverbDry.connect(audioCtx.destination);
masterReverbWet.connect(audioCtx.destination);


// Create reverb impulse
const sampleRate = audioCtx.sampleRate;
const length = sampleRate * 2;
const impulse = audioCtx.createBuffer(2, length, sampleRate);
const impulseL = impulse.getChannelData(0);
const impulseR = impulse.getChannelData(1);
for (let i = 0; i < length; i++) {
    impulseL[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
    impulseR[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
}
masterReverb.buffer = impulse;

// Instantiate Decks
const deckA = new Deck('A', audioCtx, gainA);
const deckB = new Deck('B', audioCtx, gainB);

// --- Mixer and Master FX Event Listeners ---
const crossfader = document.getElementById('crossfader');
crossfader.addEventListener('input', (e) => {
    const value = parseFloat(e.target.value);
    const gainAValue = Math.cos((value + 1) * 0.25 * Math.PI);
    const gainBValue = Math.cos((1 - value) * 0.25 * Math.PI);
    gainA.gain.setValueAtTime(gainAValue, audioCtx.currentTime);
    gainB.gain.setValueAtTime(gainBValue, audioCtx.currentTime);
});
crossfader.dispatchEvent(new Event('input')); // Set initial position

document.getElementById('master-lpf').addEventListener('input', e => masterLpf.frequency.value = e.target.value);
document.getElementById('master-hpf').addEventListener('input', e => masterHpf.frequency.value = e.target.value);
document.getElementById('master-eqgain').addEventListener('input', e => masterEq.gain.value = e.target.value);
document.getElementById('master-reverb').addEventListener('input', e => {
    const mix = parseFloat(e.target.value);
    masterReverbDry.gain.value = 1 - mix;
    masterReverbWet.gain.value = mix;
});

// --- Mobile Deck Toggle ---
const deckToggleBtn = document.getElementById('deck-toggle');
const deckAContainer = document.getElementById('deck-A');
const deckBContainer = document.getElementById('deck-B');
deckToggleBtn.addEventListener('click', () => {
    const isBVisible = !deckBContainer.classList.contains('hidden');
    if (isBVisible) {
        deckBContainer.classList.add('hidden');
        deckAContainer.classList.remove('hidden');
        deckToggleBtn.textContent = 'Show Deck B';
    } else {
        deckAContainer.classList.add('hidden');
        deckBContainer.classList.remove('hidden');
        deckToggleBtn.textContent = 'Show Deck A';
    }
});

// --- Master Recorder ---
let masterRecorder;
let isMasterRecording = false;
let audioChunks = [];
const masterRecordBtn = document.getElementById('master-record');

masterRecordBtn.addEventListener('click', () => {
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    isMasterRecording = !isMasterRecording;
    if (isMasterRecording) {
        startMasterRecording();
    } else {
        stopMasterRecording();
    }
});

function startMasterRecording() {
    audioChunks = [];
    masterRecorder = new MediaRecorder(masterRecorderDestination.stream);
    masterRecorder.ondataavailable = event => audioChunks.push(event.data);
    masterRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const url = URL.createObjectURL(audioBlob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'dj-mix.wav';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showMessageBox('Recording saved to your downloads!');
    };
    masterRecorder.start();
    masterRecordBtn.textContent = 'Stop Recording';
    masterRecordBtn.classList.add('recording');
}

function stopMasterRecording() {
    masterRecorder.stop();
    masterRecordBtn.textContent = 'Record Mix';
    masterRecordBtn.classList.remove('recording');
}


function showMessageBox(message) {
    document.getElementById('messageBoxText').textContent = message;
    document.getElementById('messageBox').style.display = 'block';
}
document.getElementById('messageBoxCloseBtn').onclick = () => {
    document.getElementById('messageBox').style.display = 'none';
};

</script>
</body>
</html>
